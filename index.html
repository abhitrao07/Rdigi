<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jio Partner Creative Generator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    :root { --blue:#0078ff; --blue-dark:#005fcc; --ok:#137333; }
    body { font-family: Arial, sans-serif; margin: 30px; text-align: center; }
    .container { max-width: 900px; margin: auto; }
    canvas { border: 1px solid #ccc; margin-top: 16px; max-width: 100%; }
    .row { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    input, button { padding: 10px; font-size: 16px; }
    button { background: var(--blue); color: #fff; border: none; border-radius: 6px; cursor: pointer; }
    button:hover { background: var(--blue-dark); }
    button[disabled] { opacity: .5; cursor: not-allowed; }
    .subhead { color: var(--ok); margin: 8px 0; }
    .fileline { display:flex; justify-content:center; gap:8px; margin-top:6px; }
    .clearX { color:#d11; font-size:18px; cursor:pointer; }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>

<body>
<div class="container">
  <h2>Generate Your Jio Creative</h2>
  <div id="entryCount" class="subhead">Entries: 0</div>

  <div class="row">
    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls">
    <button onclick="downloadTemplate()">Download CSV Template</button>
  </div>

  <div class="fileline" id="fileLine" style="display:none;">
    <span id="fileName"></span>
    <span class="clearX" onclick="clearFile()">Ã—</span>
  </div>

  <div class="row">
    <input id="singleId" placeholder="Enter Partner ID (if no file)">
  </div>

  <div class="row">
    <button id="generateBtn" disabled>Generate</button>
  </div>

  <canvas id="canvas"></canvas>
</div>

<script>
const baseImagePath = "base.jpg";
let UPLOADED = {};
let IDS = [];

const fileInput = document.getElementById("fileInput");
const fileLine  = document.getElementById("fileLine");
const fileName  = document.getElementById("fileName");
const entryCnt  = document.getElementById("entryCount");
const genBtn    = document.getElementById("generateBtn");
const singleId  = document.getElementById("singleId");

const normId = v => (v || "").toString().trim().toUpperCase();
const normTxt = v => (v || "")
  .toString()
  .replace(/\u00A0/g," ")
  .replace(/\s+/g," ")
  .trim();

fileInput.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  UPLOADED = {};
  IDS = [];

  let rows = [];

  if (file.name.endsWith(".csv")) {
    const text = (await file.text()).replace(/\r/g,"\n");
    const lines = text.split("\n").filter(l => l.trim());
    const headers = lines[0].toLowerCase();

    for (let i = 1; i < lines.length; i++) {
      const [id, name] = lines[i].split(",");
      const pid = normId(id);
      if (pid) rows.push([pid, normTxt(name)]);
    }
  } else {
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf);
    const ws = wb.Sheets[wb.SheetNames[0]];
    const json = XLSX.utils.sheet_to_json(ws, { defval:"" });

    json.forEach(r => {
      const pid = normId(r.partner_id || r.partnerid || r.id);
      if (pid) rows.push([pid, normTxt(r.store_name || r.storename || r.store)]);
    });
  }

  rows.forEach(([id, name]) => {
    if (!UPLOADED[id]) IDS.push(id);
    UPLOADED[id] = name || "";
  });

  fileName.textContent = `${file.name} (${IDS.length})`;
  fileLine.style.display = "flex";
  updateUI();
});

function clearFile() {
  UPLOADED = {};
  IDS = [];
  fileInput.value = "";
  fileLine.style.display = "none";
  updateUI();
}

singleId.addEventListener("input", updateUI);

function updateUI() {
  entryCnt.textContent = `Entries: ${IDS.length}`;
  genBtn.disabled = !(IDS.length || singleId.value.trim());
}

document.getElementById("generateBtn").onclick = async () => {
  const zip = new JSZip();
  const ids = IDS.length ? IDS : [normId(singleId.value)];

  for (const id of ids) {
    const blob = await drawCreative(id);
    zip.file(`creative_${id}.png`, blob);
  }

  if (ids.length === 1) {
    saveAs(await zip.generateAsync({type:"blob"}), `creative_${ids[0]}.png`);
  } else {
    saveAs(await zip.generateAsync({type:"blob"}), "creatives.zip");
  }
};

async function drawCreative(id) {
  const img = await loadImage(baseImagePath);
  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  canvas.width = img.width;
  canvas.height = img.height;
  ctx.drawImage(img,0,0);

  const qrCanvas = document.createElement("canvas");
  await QRCode.toCanvas(qrCanvas, `https://wa.me/917000070000?text=${id}`);

  const qrPx = canvas.width * 0.18;
  const x = canvas.width - qrPx - canvas.width * 0.125;
  const y = canvas.height - qrPx - canvas.width * 0.16;
  ctx.drawImage(qrCanvas, x, y, qrPx, qrPx);

  const label = UPLOADED[id] ? `${id} | ${UPLOADED[id]}` : id;
  ctx.font = `${canvas.width * 0.025}px Arial`;
  ctx.textAlign = "center";
  ctx.fillText(label, x + qrPx/2, y + qrPx + qrPx*0.08);

  return new Promise(r => canvas.toBlob(r));
}

function loadImage(src) {
  return new Promise((res,rej)=>{
    const i = new Image(); i.onload=()=>res(i); i.onerror=rej; i.src=src;
  });
}

function downloadTemplate() {
  const csv = "partner_id,store_name\nT7CA,\nTKC2,\n9561,\n";
  saveAs(new Blob([csv],{type:"text/csv"}),"partner_template.csv");
}
</script>
</body>
</html>
